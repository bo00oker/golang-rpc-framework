# API Gateway æ¶æ„è®¾è®¡

## ğŸ—ï¸ æ•´ä½“æ¶æ„

API Gatewayä½œä¸ºå¾®æœåŠ¡æ¶æ„çš„ç»Ÿä¸€å…¥å£ï¼Œæä¾›äº†ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Client Applications                      â”‚
â”‚             (Web, Mobile, Third-party APIs)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ HTTP/HTTPS
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  API Gateway (Port: 8080)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ HTTP Server â”‚ â”‚ Middleware  â”‚ â”‚ Router      â”‚           â”‚
â”‚  â”‚             â”‚ â”‚ - Auth      â”‚ â”‚ - /api/v1   â”‚           â”‚
â”‚  â”‚ - CORS      â”‚ â”‚ - Logging   â”‚ â”‚ - /health   â”‚           â”‚
â”‚  â”‚ - Rate Lmt  â”‚ â”‚ - Metrics   â”‚ â”‚ - /metrics  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              RPC Client Manager                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ Service  â”‚ â”‚ Load     â”‚ â”‚ Connection Pool         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚Discovery â”‚ â”‚Balancing â”‚ â”‚ - Health Check          â”‚ â”‚ â”‚
â”‚  â”‚  â”‚ (Nacos)  â”‚ â”‚(Round    â”‚ â”‚ - Auto Reconnect        â”‚ â”‚ â”‚
â”‚  â”‚  â”‚          â”‚ â”‚ Robin)   â”‚ â”‚ - Circuit Breaker       â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ gRPC
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Backend Microservices                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚User Service â”‚    â”‚Order Serviceâ”‚    â”‚  ... More   â”‚     â”‚
â”‚  â”‚Port: 50051  â”‚    â”‚Port: 50052  â”‚    â”‚  Services   â”‚     â”‚
â”‚  â”‚             â”‚    â”‚             â”‚    â”‚             â”‚     â”‚
â”‚  â”‚- CRUD Users â”‚    â”‚- CRUD Ordersâ”‚    â”‚- Inventory  â”‚     â”‚
â”‚  â”‚- Profile Mgmtâ”‚   â”‚- Order Itemsâ”‚    â”‚- Payment    â”‚     â”‚
â”‚  â”‚- Auth       â”‚    â”‚- Status Mgmtâ”‚    â”‚- Notificationâ”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. HTTP Server
- **æ¡†æ¶**: Gorilla Mux
- **åŠŸèƒ½**: å¤„ç†HTTPè¯·æ±‚ï¼Œæ”¯æŒRESTful API
- **ç‰¹æ€§**: 
  - æ”¯æŒè·¯å¾„å‚æ•°å’ŒæŸ¥è¯¢å‚æ•°
  - è‡ªåŠ¨å†…å®¹åå•†
  - ä¼˜é›…å…³é—­

### 2. ä¸­é—´ä»¶ç³»ç»Ÿ
```go
// ä¸­é—´ä»¶æ‰§è¡Œé¡ºåº
Request â†’ CORS â†’ Logging â†’ Metrics â†’ RateLimit â†’ Auth â†’ Handler
```

#### CORSä¸­é—´ä»¶
- è·¨åŸŸèµ„æºå…±äº«æ”¯æŒ
- æ”¯æŒé¢„æ£€è¯·æ±‚(OPTIONS)
- å¯é…ç½®å…è®¸çš„åŸŸåã€æ–¹æ³•ã€å¤´éƒ¨

#### è®¤è¯ä¸­é—´ä»¶
- JWT TokenéªŒè¯
- Bearer Tokenæ ¼å¼
- ç”¨æˆ·ä¿¡æ¯æ³¨å…¥Context

#### æ—¥å¿—ä¸­é—´ä»¶
- ç»“æ„åŒ–æ—¥å¿—è®°å½•
- è¯·æ±‚å“åº”æ—¶é—´ç»Ÿè®¡
- é”™è¯¯é“¾è·¯è¿½è¸ª

#### æŒ‡æ ‡ä¸­é—´ä»¶
- PrometheusæŒ‡æ ‡æ”¶é›†
- HTTPè¯·æ±‚è®¡æ•°
- å“åº”æ—¶é—´åˆ†å¸ƒ
- é”™è¯¯ç‡ç»Ÿè®¡

#### é™æµä¸­é—´ä»¶
- åŸºäºIPçš„é™æµ
- æ»‘åŠ¨çª—å£ç®—æ³•
- å¯é…ç½®é™æµé˜ˆå€¼

### 3. è·¯ç”±ç³»ç»Ÿ

#### RESTful APIè®¾è®¡
```
/api/v1/auth/
â”œâ”€â”€ POST /login          # ç”¨æˆ·ç™»å½•
â”œâ”€â”€ POST /refresh        # åˆ·æ–°Token
â””â”€â”€ POST /logout         # ç”¨æˆ·ç™»å‡º

/api/v1/users/
â”œâ”€â”€ POST /               # åˆ›å»ºç”¨æˆ·
â”œâ”€â”€ GET /                # æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
â”œâ”€â”€ GET /{id}            # è·å–ç”¨æˆ·è¯¦æƒ…
â”œâ”€â”€ PUT /{id}            # æ›´æ–°ç”¨æˆ·ä¿¡æ¯
â””â”€â”€ DELETE /{id}         # åˆ é™¤ç”¨æˆ·

/api/v1/orders/
â”œâ”€â”€ POST /               # åˆ›å»ºè®¢å•
â”œâ”€â”€ GET /                # æŸ¥è¯¢è®¢å•åˆ—è¡¨
â”œâ”€â”€ GET /{id}            # è·å–è®¢å•è¯¦æƒ…
â”œâ”€â”€ PUT /{id}            # æ›´æ–°è®¢å•ä¿¡æ¯
â”œâ”€â”€ DELETE /{id}         # åˆ é™¤è®¢å•
â””â”€â”€ GET /user/{user_id}  # æ ¹æ®ç”¨æˆ·æŸ¥è¯¢è®¢å•

ç³»ç»Ÿæ¥å£:
â”œâ”€â”€ GET /health          # å¥åº·æ£€æŸ¥
â””â”€â”€ GET /metrics         # PrometheusæŒ‡æ ‡
```

### 4. RPCå®¢æˆ·ç«¯ç®¡ç†å™¨

#### æœåŠ¡å‘ç°
- æ”¯æŒNacoså’ŒEtcdæ³¨å†Œä¸­å¿ƒ
- è‡ªåŠ¨æœåŠ¡å®ä¾‹å‘ç°
- å®æ—¶ç›‘å¬æœåŠ¡å˜åŒ–
- æ•…éšœå®ä¾‹è‡ªåŠ¨å‰”é™¤

#### è´Ÿè½½å‡è¡¡
- è½®è¯¢(Round Robin)ç®—æ³•
- æœåŠ¡å®ä¾‹å¥åº·æ£€æŸ¥
- æ•…éšœè½¬ç§»æœºåˆ¶
- è¿æ¥å¤ç”¨

#### è¿æ¥æ± ç®¡ç†
```go
type ServiceClient struct {
    ServiceName string           // æœåŠ¡åç§°
    Connections []*grpc.ClientConn  // gRPCè¿æ¥æ± 
    Clients     []interface{}    // å®¢æˆ·ç«¯å®ä¾‹æ± 
    CurrentIdx  int             // å½“å‰è½®è¯¢ç´¢å¼•
    healthy     bool            // å¥åº·çŠ¶æ€
}
```

## ğŸ” å®‰å…¨ç‰¹æ€§

### JWTè®¤è¯
- RSA 2048ä½å¯†é’¥å¯¹
- è®¿é—®ä»¤ç‰Œ(1å°æ—¶è¿‡æœŸ)
- åˆ·æ–°ä»¤ç‰Œ(24å°æ—¶è¿‡æœŸ)
- è‡ªåŠ¨ä»¤ç‰Œåˆ·æ–°æœºåˆ¶

### RBACæƒé™æ§åˆ¶
```go
// æƒé™æ¨¡å‹
admin: æ‰€æœ‰æƒé™
user:  ç”¨æˆ·å’Œè®¢å•çš„åŸºæœ¬æ“ä½œ
guest: åªè¯»æƒé™

// æƒé™æ˜ å°„
"user:create" "user:read" "user:update" "user:delete"
"order:create" "order:read" "order:update" "order:delete"
```

### ç™½åå•æœºåˆ¶
```go
// æ— éœ€è®¤è¯çš„æ¥å£
"/api/v1/users"               // POST - ç”¨æˆ·æ³¨å†Œ
"/api/v1/auth/login"          // ç™»å½•
"/api/v1/auth/refresh"        // åˆ·æ–°ä»¤ç‰Œ
"/health"                     // å¥åº·æ£€æŸ¥
```

## ğŸ“Š ç›‘æ§å¯è§‚æµ‹æ€§

### PrometheusæŒ‡æ ‡
```
# HTTPè¯·æ±‚æŒ‡æ ‡
gateway_http_requests_total{method, path, status}
gateway_http_request_duration_seconds{method, path}
gateway_http_requests_in_flight{method, path}

# RPCå®¢æˆ·ç«¯æŒ‡æ ‡
gateway_rpc_requests_total{service, method, status}
gateway_rpc_request_duration_seconds{service, method}
gateway_rpc_connections_active{service}

# ä¸šåŠ¡æŒ‡æ ‡
gateway_rate_limit_hits_total{source_ip}
gateway_auth_failures_total{reason}
```

### å¥åº·æ£€æŸ¥
```json
{
  "status": "healthy",
  "checks": {
    "gateway": "healthy",
    "rpc_clients": "healthy",
    "user_service": "healthy",
    "order_service": "healthy"
  }
}
```

### åˆ†å¸ƒå¼è¿½è¸ª
- OpenTelemetryé›†æˆ
- Jaegeré“¾è·¯è¿½è¸ª
- è·¨æœåŠ¡è°ƒç”¨é“¾
- æ€§èƒ½ç“¶é¢ˆåˆ†æ

## ğŸš€ éƒ¨ç½²æ¶æ„

### å•æœºéƒ¨ç½²
```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
./scripts/start_with_gateway.sh start

# å¯åŠ¨é¡ºåº
1. User Service (Port: 50051)
2. Order Service (Port: 50052)  
3. Gateway (Port: 8080)
```

### å®¹å™¨åŒ–éƒ¨ç½²
```dockerfile
# Gateway Dockerfile
FROM golang:1.24-alpine AS builder
WORKDIR /app
COPY . .
RUN go build -o gateway ./cmd/gateway

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/gateway .
COPY ./configs ./configs
CMD ["./gateway"]
```

### Kuberneteséƒ¨ç½²
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
spec:
  replicas: 3
  selector:
    matchLabels:
      app: api-gateway
  template:
    metadata:
      labels:
        app: api-gateway
    spec:
      containers:
      - name: gateway
        image: rpc-framework/gateway:latest
        ports:
        - containerPort: 8080
        env:
        - name: NACOS_SERVER_ADDR
          value: "nacos-service:8848"
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
```

## ğŸ”„ APIè¯·æ±‚æµç¨‹

### å…¸å‹è¯·æ±‚æµç¨‹
```
1. å®¢æˆ·ç«¯å‘é€HTTPè¯·æ±‚åˆ°Gateway
   â†“
2. CORSä¸­é—´ä»¶å¤„ç†è·¨åŸŸ
   â†“
3. æ—¥å¿—ä¸­é—´ä»¶è®°å½•è¯·æ±‚
   â†“
4. æŒ‡æ ‡ä¸­é—´ä»¶ç»Ÿè®¡
   â†“
5. é™æµä¸­é—´ä»¶æ£€æŸ¥é¢‘ç‡
   â†“
6. è®¤è¯ä¸­é—´ä»¶éªŒè¯Token(å¦‚éœ€è¦)
   â†“
7. è·¯ç”±å™¨åŒ¹é…å¤„ç†å™¨
   â†“
8. RPCå®¢æˆ·ç«¯ç®¡ç†å™¨é€‰æ‹©åç«¯æœåŠ¡
   â†“
9. è´Ÿè½½å‡è¡¡é€‰æ‹©æœåŠ¡å®ä¾‹
   â†“
10. å‘é€gRPCè¯·æ±‚åˆ°åç«¯æœåŠ¡
    â†“
11. åç«¯æœåŠ¡å¤„ç†ä¸šåŠ¡é€»è¾‘
    â†“
12. è¿”å›gRPCå“åº”
    â†“
13. Gatewayè½¬æ¢ä¸ºHTTPå“åº”
    â†“
14. è¿”å›ç»™å®¢æˆ·ç«¯
```

### é”™è¯¯å¤„ç†æµç¨‹
```
gRPCé”™è¯¯ â†’ HTTPçŠ¶æ€ç æ˜ å°„ â†’ ç»Ÿä¸€é”™è¯¯æ ¼å¼
â”œâ”€â”€ INVALID_ARGUMENT â†’ 400 Bad Request
â”œâ”€â”€ UNAUTHENTICATED  â†’ 401 Unauthorized  
â”œâ”€â”€ PERMISSION_DENIED â†’ 403 Forbidden
â”œâ”€â”€ NOT_FOUND        â†’ 404 Not Found
â”œâ”€â”€ ALREADY_EXISTS   â†’ 409 Conflict
â”œâ”€â”€ INTERNAL         â†’ 500 Internal Server Error
â””â”€â”€ UNAVAILABLE      â†’ 503 Service Unavailable
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### è¿æ¥å¤ç”¨
- gRPCè¿æ¥æ± ç®¡ç†
- HTTP Keep-Alive
- è¿æ¥å¥åº·æ£€æŸ¥
- è‡ªåŠ¨é‡è¿æœºåˆ¶

### ç¼“å­˜ç­–ç•¥
- æœåŠ¡å‘ç°ç»“æœç¼“å­˜
- JWT Tokenæœ¬åœ°éªŒè¯
- é™æ€èµ„æºç¼“å­˜
- å“åº”å†…å®¹ç¼“å­˜

### å¹¶å‘æ§åˆ¶
- Goroutineæ± ç®¡ç†
- è¯·æ±‚å¹¶å‘é™åˆ¶
- èµ„æºç«äº‰é¿å…
- ä¼˜é›…å…³é—­

## ğŸ”§ é…ç½®ç®¡ç†

### Gatewayé…ç½®
```yaml
gateway:
  port: 8080                    # ç›‘å¬ç«¯å£
  read_timeout: 30s             # è¯»å–è¶…æ—¶
  write_timeout: 30s            # å†™å…¥è¶…æ—¶
  enable_cors: true             # å¯ç”¨CORS
  enable_auth: true             # å¯ç”¨è®¤è¯
  enable_metrics: true          # å¯ç”¨æŒ‡æ ‡
  enable_rate_limit: true       # å¯ç”¨é™æµ
  rate_limit: 1000              # æ¯åˆ†é’Ÿè¯·æ±‚é™åˆ¶

security:
  jwt_secret: "your-secret"     # JWTå¯†é’¥
  token_expiry: 1h              # Tokenè¿‡æœŸæ—¶é—´
  refresh_expiry: 24h           # åˆ·æ–°Tokenè¿‡æœŸæ—¶é—´

registry:
  type: "nacos"                 # æ³¨å†Œä¸­å¿ƒç±»å‹
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### APIæµ‹è¯•
```bash
# è¿è¡ŒGateway APIæµ‹è¯•
./scripts/test_gateway.sh test

# æµ‹è¯•è¦†ç›–
- å¥åº·æ£€æŸ¥
- ç”¨æˆ·è®¤è¯
- CRUDæ“ä½œ
- é”™è¯¯å¤„ç†
- æƒé™æ§åˆ¶
```

### æ€§èƒ½æµ‹è¯•
- å¹¶å‘ç”¨æˆ·æµ‹è¯•
- å‹åŠ›æµ‹è¯•
- å†…å­˜æ³„æ¼æ£€æµ‹
- å“åº”æ—¶é—´åˆ†æ

### é›†æˆæµ‹è¯•
- ç«¯åˆ°ç«¯æµ‹è¯•
- æœåŠ¡é—´é€šä¿¡æµ‹è¯•
- æ•…éšœæ¢å¤æµ‹è¯•
- æ•°æ®ä¸€è‡´æ€§æµ‹è¯•

## ğŸ¯ æœªæ¥æ‰©å±•

### é«˜çº§ç‰¹æ€§
- [ ] APIç‰ˆæœ¬ç®¡ç†
- [ ] è¯·æ±‚/å“åº”è½¬æ¢
- [ ] WebSocketæ”¯æŒ
- [ ] GraphQLé›†æˆ
- [ ] æœåŠ¡ç½‘æ ¼é›†æˆ(Istio)

### è¿ç»´ç‰¹æ€§
- [ ] è“ç»¿éƒ¨ç½²
- [ ] é‡‘ä¸é›€å‘å¸ƒ
- [ ] è‡ªåŠ¨æ‰©ç¼©å®¹
- [ ] æ™ºèƒ½è·¯ç”±
- [ ] A/Bæµ‹è¯•

### å®‰å…¨å¢å¼º
- [ ] OAuth2é›†æˆ
- [ ] APIå¯†é’¥ç®¡ç†
- [ ] WAFé˜²æŠ¤
- [ ] DDoSé˜²æŠ¤
- [ ] æ•°æ®åŠ å¯†

è¿™ä¸ªGatewayæ¶æ„æä¾›äº†å®Œæ•´çš„å¾®æœåŠ¡å…¥å£è§£å†³æ–¹æ¡ˆï¼Œå…·å¤‡ç”Ÿäº§çº§çš„å¯é æ€§ã€å®‰å…¨æ€§å’Œå¯è§‚æµ‹æ€§ã€‚